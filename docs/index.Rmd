---
title: "R Programming Assignment"
author: "Nicolas Martinez-Wise"
date: ""
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message=FALSE, warnings=FALSE)
```

## Research question: What are the trends in the number of methadone prescriptions in Scotland over the past 10 years and how do they vary with the number of heroin-related (due to overdose) hospital stays (in general acute and psychiatric hospitals; as an indicator of heroin addiction prevalence in the population) over the same period?

```{r, include=FALSE}

library(tidyverse)
library(here)
library(janitor)
library(sf)

```

Load NHS Scotland health board name data, health board geospatial data, and opioid-related hospital stays data.
```{r}

healthboard_names_and_spatial_data <- st_read(here("data", "health_board_spatial_data", "NHS_healthboards_2019.shp")) %>%
  # Clean column names for consistency
  clean_names() %>% 
  # Rename column for clarity 
  rename(hb_geometry = geometry) %>%
  # Add "NHS" prefix to every entry in the hb_name column (the health board names) and change " and " to " & "
  mutate(hb_name = str_replace(paste0("NHS ", hb_name), " and ", " & "))

drug_related_hospital_statistics <- read_csv(here("data", "drug_related_hospital_statistics.csv")) %>% 
  clean_names() %>% 
  # Rename columns for clarity and consistency
  rename(hb_name = location, overdose_hospital_stays = value) 
  
```

Join the health board names and spatial data with the opioid-related hospital stays data.
```{r}

drug_related_hospital_statistics <- drug_related_hospital_statistics %>%
  full_join(healthboard_names_and_spatial_data, join_by("hb_name")) %>%
  # Select relevant columns
  select(financial_year, hb_name, hb_code, drug_type, overdose_hospital_stays, hb_geometry)

drug_related_hospital_statistics %>% 
  filter(drug_type == "Heroin") %>%
  ggplot(aes(fill = overdose_hospital_stays)) +
  geom_sf(aes(geometry = hb_geometry)) +
  scale_fill_distiller(palette = "Spectral") +
  labs(title = "Number of Heroin-Related Hospital Stays\n Caused by Overdose across Health Boards") + 
   theme_void() 

```
## do the big download thing and then create function to concatenate all the monthly data into yearly data

